% use fc_ruhoff2
% anharmonic oscillator V = 1/2 omega^2 Q^2 + a Q^3
clear;
clc;
n1 = 20;
n2 = 180;
w1 = 0.0178; % eV
w2 = 0.0122;
a1 = 0.00265; % ev/[sqrt(amu)*Ang]^3
a2 = 0.00113;
a3 = 7.8e-5;
k = 9.157; % sqrt(amu)*Ang
sigma = 0.03;
T = 300; % K
T = T*8.621738e-5; 
zpl = 4.0;
ne = 101;
%unit conversion
hbar = 6.582119514e-16;
ev = 1.6021766208e-19;
amu = 1.660539040e-27;
ang = 1.0e-10;
fr = ev/amu/ang^2;
b1 = sqrt(w1*fr/2/(w1/hbar)^2); % b = sqrt(hbar/2/omega)
b2 = sqrt(w2*fr/2/(w2/hbar)^2);
%
f = fc_ruhoff2(n1,n2,w1,w2,k);

e = linspace(1.5,4,ne)';
p = zeros([ne,1]);
for ie=1:ne
    for i=0:n1-3
        for j=0:n2-3
            %ei = i*w1;
            % second order perturbation
            ei = w1*(i+0.5)-30*a1^2*b1^6/w1*(i^2+i+11/30);
            %ef = j*w2;
            %ef = w2*(j+0.5)-30*a2^2*b2^6/w2*(j^2+j+11/30);
            ef = w2*(j+0.5)+6*a3*b2^4*((j+0.5)^2+0.25);
            bz = exp(-ei/T);
            if bz < 1.0e-12
                bz = 0;
            end
            fci = f(id(i),id(j))...
                +a2*b2^3/w2...
                *(sqrt(j*(j-1)*(j-2))/3*fc(i,j-3,f)...
                +3*sqrt(j^3)*fc(i,j-1,f)...
                -3*sqrt((j+1)^3)*fc(i,j+1,f)...
                -sqrt((j+1)*(j+2)*(j+3))/3*fc(i,j+3,f))...
                +a1*a2*b1^3*b2^3/w1/w2...
                *(sqrt(j*(j-1)*(j-2)*i*(i-1)*(i-2))/9*fc(i-3,j-3,f) ...
                +sqrt(j*(j-1)*(j-2)*i^3)*fc(i-1,j-3,f)...
                -sqrt(j*(j-1)*(j-2)*(i+1)^3)*fc(i+1,j-3,f)...
                -sqrt(j*(j-1)*(j-2)*(i+1)*(i+2)*(i+3))/9*fc(i+3,j-3,f)...
                +sqrt(i*(i-1)*(i-2)*j^3)*fc(i-3,j-1,f)...
                +9*sqrt(i^3*j^3)*fc(i-1,j-1,f)...
                -9*sqrt(j^3*(i+1)^3)*fc(i+1,j-1,f)...
                -sqrt(j^3*(i+1)*(i+2)*(i+3))*fc(i+3,j-1,f)...
                -sqrt(i*(i-1)*(i-2)*(j+1)^3)*fc(i-3,j+1,f)...
                -9*sqrt(i^3*(j+1)^3)*fc(i-1,j+1,f)...
                +9*sqrt((i+1)^3*(j+1)^3)*fc(i+1,j+1,f)...
                +sqrt((j+1)^3*(i+1)*(i+2)*(i+3))*fc(i+3,j+1,f)...
                -sqrt(i*(i-1)*(i-2)*(j+1)*(j+2)*(j+3))/9*fc(i-3,j+3,f)...
                -sqrt(i^3*(j+1)*(j+2)*(j+3))*fc(i-1,j+3,f)...
                +sqrt((i+1)^3*(j+1)*(j+2)*(j+3))*fc(i+1,j+3,f)...
                +sqrt((j+1)*(j+2)*(j+3)*(i+1)*(i+2)*(i+3))/9*fc(i+3,j+3,f))...
                +a1*b1^3/w1...
                *(sqrt(i*(i-1)*(i-2))/3*fc(i-3,j,f)...
                +3*sqrt(i^3)*fc(i-1,j,f)...
                -3*sqrt((i+1)^3)*fc(i+1,j,f)...
                -sqrt((i+1)*(i+2)*(i+3))/3*fc(i+3,j,f));
            fci = fci^2;
            p(ie) = p(ie)+e(ie)^3*bz*fci*lorentzian(e(ie),zpl+ei-ef,sigma);
        end
    end
end

function [ r ] = fc( n,m,f )
    if n < 0 || m < 0
        r = 0.0;
    else
        r = f(id(n),id(m));
    end
end